<!DOCTYPE html>
<meta charset="utf-8" />

<!-- Load d3.js -->
<script src="https://d3js.org/d3.v4.js"></script>

<!-- Load -->

<!-- Load d3-cloud -->
<script src="https://cdn.jsdelivr.net/gh/holtzy/D3-graph-gallery@master/LIB/d3.layout.cloud.js"></script>

<!-- Create a div where the graph will take place -->
<h2>Vader Sentiment Results - PI Chart</h2>
<div id="pi-visualization"></div>

<p>
  Positive: {{ piResults["Positive"] }} <br />
  Negative: {{ piResults["Negative"] }} <br />
  Neutral: {{ piResults["Neutral"] }}
</p>

<h2>Vader Sentiment Results - Bubble Cloud</h2>
<div id="bubble-visualization"></div>

<h2>Vader Sentiment Results - Word Cloud</h2>
<div id="cloud-visualization"></div>

<script>

  // set the dimensions and margins of the graph
  var width = 450
  height = 450
  margin = 40

  // The radius of the pieplot is half the width or half the height (smallest one). I subtract a bit of margin.
  var radius = Math.min(width, height) / 2 - margin

  // append the svg object to the div called 'my_dataviz'
  var svg = d3.select("#pi-visualization")
      .append("svg")
      .attr("width", width)
      .attr("height", height)
      .append("g")
      .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

  // Create dummy data
  var data = {{ piResults| tojson}};

  // set the color scale
  //var color = d3.scaleOrdinal()
  //  .domain(data)
  //  .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56"])

  var color = d3.scaleOrdinal().domain(["Positive", "Negative", "Neutral"]).range(["#7fffd4", "#cd5c5c", "#808080"]);

  // Compute the position of each group on the pie:
  var pie = d3.pie()
      .value(function (d) { return d.value; })
  var data_ready = pie(d3.entries(data))

  // Build the pie chart: Basically, each part of the pie is a path that we build using the arc function.
  svg
      .selectAll('whatever')
      .data(data_ready)
      .enter()
      .append('path')
      .attr('d', d3.arc()
          .innerRadius(100)         // This is the size of the donut hole
          .outerRadius(radius)
      )
      .attr('fill', function (d) { return (color(d.data.key)) })
      .attr("stroke", "black")
      .style("stroke-width", "2px")
      .style("opacity", 0.7)
</script>

<script type="text/javascript">

  dataset = { "children": {{ bubbleResults | tojson }}};

  var diameter = 550;
  var color = d3.scaleOrdinal(d3.schemeCategory20);

  var bubble = d3.pack(dataset)
      .size([diameter, diameter])
      .padding(1.5);

  var svg = d3.select("#bubble-visualization")
      .append("svg")
      .attr("width", diameter)
      .attr("height", diameter)
      .attr("class", "bubble");

  var nodes = d3.hierarchy(dataset).sum(function (d) { return d.Count; });

  console.log(nodes)

  var node = svg.selectAll(".node")
      .data(bubble(nodes).descendants())
      .enter()
      .filter(function (d) {
          return !d.children
      })
      .append("g")
      .attr("class", "node")
      .attr("transform", function (d) {
          return "translate(" + d.x + "," + d.y + ")";
      });

  node.append("title")
      .text(function (d) {
          return d.Name + ": " + d.Count;
      });

  node.append("circle")
      .attr("r", function (d) {
          return d.r;
      })
      .style("fill", function (d, i) {
          return color(i);
      });

  node.append("text")
      .attr("dy", ".2em")
      .style("text-anchor", "middle")
      .text(function (d) {
          return d.data.Name.substring(0, d.r / 3);
      })
      .attr("font-family", "sans-serif")
      .attr("font-size", function (d) {
          return d.r / 5;
      })
      .attr("fill", "white");

  node.append("text")
      .attr("dy", "1.3em")
      .style("text-anchor", "middle")
      .text(function (d) {
          return d.data.Count;
      })
      .attr("font-family", "Gill Sans", "Gill Sans MT")
      .attr("font-size", function (d) {
          return d.r / 5;
      })
      .attr("fill", "white");

  d3.select(self.frameElement)
      .style("height", diameter + "px");
</script>

<script>

  // List of words
  var myWords = {{ cloudResults| tojson }}

  var color = d3.scaleOrdinal(d3.schemeCategory20);

  // set the dimensions and margins of the graph
  var margin = { top: 10, right: 10, bottom: 10, left: 10 },
      width = 450 - margin.left - margin.right,
      height = 450 - margin.top - margin.bottom;

  // append the svg object to the body of the page
  var svg = d3.select("#cloud-visualization").append("svg")
      .attr("width", width + margin.left + margin.right)
      .attr("height", height + margin.top + margin.bottom)
      .append("g")
      .attr("transform",
          "translate(" + margin.left + "," + margin.top + ")");

  // Constructs a new cloud layout instance. It run an algorithm to find the position of words that suits your requirements
  // Wordcloud features that are different from one word to the other must be here
  var layout = d3.layout.cloud()
      .size([width, height])
      .words(myWords.map(function (d) { return { text: d.word, size: d.size }; }))
      .padding(5)        //space between words
      .rotate(function () { return ~~(Math.random() * 2) * 90; })
      .fontSize(function (d) { return d.size; })  // font size of words
      .on("end", draw);
  layout.start();

  // This function takes the output of 'layout' above and draw the words
  // Wordcloud features that are THE SAME from one word to the other can be here
  function draw(words) {
      svg
          .append("g")
          .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
          .selectAll("text")
          .data(words)
          .enter().append("text")
          .style("font-size", function (d) { return d.size; })
          .style("fill", "#69b3a2")
          .attr("text-anchor", "middle")
          .style("font-family", "Impact")
          .style("fill", function (d, i) { return color(i); })
          .attr("transform", function (d) {
              return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
          })
          .text(function (d) { return d.text; });
  }
</script>